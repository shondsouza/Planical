<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Virtual Consultation - Doctor View - Planical</title>
  
  <!-- Global functions to prevent reference errors -->
  <script>
    // GLOBAL SAFETY FUNCTIONS - VERSION 2025-04-19-v8
    console.log("Loading global safety functions v8");
    
    // Define critical functions globally to prevent reference errors
    window.safeUISetup = function() {
      try {
        console.log("Global safety: Setting up UI elements");
        
        // Setup toggle button
        const toggleBtn = document.getElementById('status-toggle');
        if (toggleBtn) {
          // Remove existing listeners
          const newToggleBtn = toggleBtn.cloneNode(true);
          toggleBtn.parentNode.replaceChild(newToggleBtn, toggleBtn);
          
          // Add safe listener
          newToggleBtn.addEventListener('click', function() {
            if (typeof window.toggleAvailabilityClean === 'function') {
              window.toggleAvailabilityClean();
            } else if (typeof toggleAvailability === 'function') {
              toggleAvailability();
            } else {
              console.error("No toggle availability function found");
            }
          });
        }
        
        // Setup periodic request check
        const doctorId = document.getElementById('doctor-id')?.value || 
                        document.querySelector('meta[name="doctor-id"]')?.content || 
                        "N/A";
        
        if (!window.requestCheckInterval) {
          window.requestCheckInterval = setInterval(function() {
            if (typeof manualCheckForRequests === 'function') {
              manualCheckForRequests(doctorId);
            }
          }, 60000);
        }
        
        // Update last check time
        const waitingArea = document.querySelector('.waiting-area');
        if (waitingArea && !document.getElementById('lastCheckTime')) {
          const timeEl = document.createElement('p');
          timeEl.className = 'text-muted mt-3 small';
          timeEl.innerHTML = 'Last checked: <span id="lastCheckTime">Just now</span>';
          waitingArea.appendChild(timeEl);
          
          if (typeof updateLastCheckTime === 'function') {
            updateLastCheckTime();
          }
        }
      } catch (error) {
        console.error("Global safety: Error setting up UI -", error);
      }
    };
    
    // Safe update socket status function
    window.safeUpdateSocketStatus = function(status, message) {
      try {
        console.log("Global safety: Status update:", status, message);
        
        // Try to use the existing function if it exists
        if (typeof updateSocketStatus === 'function') {
          updateSocketStatus(status, message);
          return;
        }
        
        // Create or get status indicator
        let statusIndicator = document.querySelector('.connection-status');
        if (!statusIndicator) {
          statusIndicator = document.createElement('div');
          statusIndicator.className = 'connection-status';
          
          const indicator = document.createElement('div');
          indicator.className = 'status-indicator';
          
          statusIndicator.appendChild(indicator);
          document.body.appendChild(statusIndicator);
        }
        
        // Update indicator
        const indicator = statusIndicator.querySelector('.status-indicator');
        if (indicator) {
          // Reset classes
          indicator.className = 'status-indicator';
          
          // Set class based on status
          if (status === 'Online' || status === 'Connected') {
            indicator.classList.add('online');
          } else if (status === 'Offline') {
            indicator.classList.add('offline');
          } else if (status === 'Partial' || status === 'Limited') {
            indicator.classList.add('partial');
          } else {
            indicator.classList.add('disconnected');
          }
          
          // Set content
          indicator.innerHTML = `<i class="bi ${status === 'Online' || status === 'Connected' ? 'bi-wifi' : 'bi-wifi-off'}"></i> ${status}: ${message || ''}`;
        }
      } catch (error) {
        console.error("Global safety: Error updating socket status -", error);
      }
    };
    
    // Safe show notification function
    window.safeShowNotification = function(message, type) {
      try {
        console.log("Global safety: Notification -", message, type);
        
        // Try to use the existing function first
        if (typeof showNotification === 'function') {
          showNotification(message, type);
          return;
        }
        
        // Wait for DOM to be loaded before creating elements
        const showNotification = function() {
          // Check if notification element exists
          let notification = document.querySelector('.notification');
          
          // Create if doesn't exist
          if (!notification) {
            notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.maxWidth = '350px';
            notification.style.zIndex = '9999';
            notification.style.boxShadow = '0 0.5rem 1rem rgba(0, 0, 0, 0.15)';
            notification.style.borderRadius = '0.25rem';
            notification.style.overflow = 'hidden';
            
            notification.innerHTML = `
              <div class="toast show">
                <div class="toast-header">
                  <strong class="me-auto">Notification</strong>
                  <button type="button" class="btn-close" onclick="this.closest('.notification').style.display='none'"></button>
                </div>
                <div class="toast-body"></div>
              </div>
            `;
            
            document.body.appendChild(notification);
          }
          
          // Get message element
          const msgElement = notification.querySelector('.toast-body');
          if (!msgElement) return;
          
          // Set message
          msgElement.textContent = message;
          
          // Set style based on type
          const toast = notification.querySelector('.toast');
          if (toast) {
            toast.className = 'toast show';
            
            if (type === 'success') {
              toast.classList.add('bg-success', 'text-white');
            } else if (type === 'error') {
              toast.classList.add('bg-danger', 'text-white');
            } else if (type === 'warning') {
              toast.classList.add('bg-warning');
            } else {
              toast.classList.add('bg-info', 'text-white');
            }
          }
          
          // Show notification
          notification.style.display = 'block';
          
          // Auto-hide after 5 seconds
          setTimeout(function() {
            notification.style.display = 'none';
          }, 5000);
        };
        
        // Check if document is ready
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
          showNotification();
        } else {
          // Wait for DOM to be ready
          document.addEventListener('DOMContentLoaded', showNotification);
        }
      } catch (error) {
        console.error("Global safety: Error showing notification -", error);
      }
    };
    
    // Safe add consultation request function
    window.safeAddConsultationRequest = function(data) {
      try {
        console.log("Global safety: Adding consultation request -", data);
        
        // If the original function exists, try to use it
        if (typeof addConsultationRequest === 'function') {
          addConsultationRequest(data);
          return;
        }
        
        // Wait for DOM to be loaded before manipulating
        const addRequest = function() {
          // Fallback implementation
          const requestsContainer = document.getElementById('consultation-requests');
          const noRequestsMsg = document.getElementById('noRequestsMessage');
          
          if (!requestsContainer) {
            console.error("Requests container not found");
            return;
          }
          
          // Hide "no requests" message
          if (noRequestsMsg) {
            noRequestsMsg.style.display = 'none';
          }
          
          // Create request element
          const requestId = data.requestId || data.consultationId || Date.now();
          const patientName = data.patientName || data.patient_name || 'Anonymous Patient';
          const symptoms = data.symptoms || 'No symptoms specified';
          const urgency = data.urgency || 'Normal';
          
          const requestEl = document.createElement('div');
          requestEl.className = 'consultation-request-item';
          requestEl.id = `request-${requestId}`;
          
          // Set different class for urgent requests
          if (urgency === 'Urgent' || urgency === 'urgent' || urgency === 'high') {
            requestEl.classList.add('urgent');
          }
          
          // Create request HTML
          requestEl.innerHTML = `
            <div class="consultation-request-header">
              <div class="patient-info">
                <div class="patient-avatar">${patientName.charAt(0)}</div>
                <div>
                  <h4>${patientName}</h4>
                  <p class="timestamp">${new Date().toLocaleTimeString()}</p>
                </div>
              </div>
              <div class="urgency-badge ${(urgency || '').toLowerCase()}">${urgency}</div>
            </div>
            <div class="consultation-request-body">
              <p><strong>Symptoms:</strong> ${symptoms}</p>
            </div>
            <div class="consultation-request-actions">
              <button class="btn btn-primary accept-btn" onclick="acceptConsultation('${requestId}')">
                <i class="bi bi-check-circle"></i> Accept
              </button>
              <button class="btn btn-outline-secondary reject-btn" onclick="rejectConsultation('${requestId}')">
                <i class="bi bi-x-circle"></i> Decline
              </button>
            </div>
          `;
          
          // Add to container
          requestsContainer.appendChild(requestEl);
          
          // Show consultation requests container
          const requestContainer = document.getElementById('consultation-request-container');
          if (requestContainer) {
            requestContainer.style.display = 'block';
          }
        };
        
        // Check if document is ready
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
          addRequest();
        } else {
          // Wait for DOM to be ready
          document.addEventListener('DOMContentLoaded', addRequest);
        }
      } catch (error) {
        console.error("Global safety: Error adding consultation request -", error);
      }
    };
    
    // Signal that global safety functions are loaded
    window.GLOBAL_SAFETY_FUNCTIONS_LOADED = true;
    console.log("Global safety functions loaded successfully");
  </script>
  
  <!-- Doctor ID for scripts -->
  <meta name="doctor-id" content="{{ session.get('user', {}).get('doctor_id', 'N/A') }}">
  
  <!-- Favicons -->
  <link href="{{url_for('static', filename='logo1.png')}}" rel="icon">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="{{url_for('static', filename='assets/vendor/bootstrap/css/bootstrap.min.css')}}" rel="stylesheet">
  <link href="{{url_for('static', filename='assets/vendor/bootstrap-icons/bootstrap-icons.css')}}" rel="stylesheet">
  
  <!-- Main CSS File -->
  <link href="{{url_for('static', filename='assets/css/style.css')}}" rel="stylesheet">
  
  <!-- Early loading override initialization script to fix issues -->
  <script src="{{url_for('static', filename='js/doctor_view_init.js')}}"></script>
  
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f5f8fa;
      padding-top: 70px;
    }
    
    .consultation-header {
      background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
      color: white;
      padding: 3rem 0;
      margin-bottom: 2rem;
      border-radius: 0 0 20px 20px;
    }
    
    .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      margin-bottom: 1.5rem;
      overflow: hidden;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 1rem 2rem rgba(0, 0, 0, 0.15);
    }
    
    .card-header {
      background-color: #fff;
      border-bottom: 1px solid rgba(0, 0, 0, 0.08);
      padding: 1.25rem 1.5rem;
      font-weight: 600;
    }
    
    .status-badge {
      display: inline-block;
      padding: 0.35rem 0.65rem;
      font-size: 0.85rem;
      font-weight: 500;
      line-height: 1;
      color: #fff;
      text-align: center;
      white-space: nowrap;
      vertical-align: baseline;
      border-radius: 50rem;
    }
    
    .status-online {
      background-color: #28a745;
    }
    
    .status-offline {
      background-color: #6c757d;
    }
    
    .status-busy {
      background-color: #dc3545;
    }
    
    .waiting-area {
      background-color: #fff;
      border-radius: 15px;
      padding: 2rem;
      text-align: center;
      margin-bottom: 2rem;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.05);
    }
    
    .waiting-area h3 {
      font-size: 1.75rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: #0d6efd;
    }
    
    .waiting-icon {
      font-size: 4rem;
      color: #0d6efd;
      margin-bottom: 1.5rem;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.1);
        opacity: 0.8;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    .status-toggle {
      background-color: #f8f9fa;
      border: 2px solid #0d6efd;
      border-radius: 50px;
      padding: 0.75rem 2rem;
      font-weight: 600;
      color: #0d6efd;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .status-toggle:hover {
      background-color: #0d6efd;
      color: white;
    }
    
    .status-toggle.active {
      background-color: #28a745;
      border-color: #28a745;
      color: white;
    }
    
    .status-toggle.inactive {
      background-color: #dc3545;
      border-color: #dc3545;
      color: white;
    }
    
    .consultation-request {
      background-color: #fff;
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border-left: 5px solid #0d6efd;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.05);
      display: none; /* Initially hidden, shown when request comes in */
    }
    
    .consultation-request.active {
      display: block;
      animation: slideIn 0.5s ease-out;
    }
    
    @keyframes slideIn {
      0% {
        transform: translateY(-20px);
        opacity: 0;
      }
      100% {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .patient-info {
      display: flex;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .patient-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: #e9ecef;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: #0d6efd;
      margin-right: 1rem;
      font-weight: 600;
    }
    
    .patient-details h4 {
      font-size: 1.25rem;
      margin-bottom: 0.25rem;
    }
    
    .patient-details p {
      color: #6c757d;
      margin-bottom: 0;
    }
    
    .action-buttons {
      display: flex;
      gap: 1rem;
    }
    
    .accept-button {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 50rem;
      font-weight: 600;
      transition: all 0.3s ease;
      flex: 1;
    }
    
    .accept-button:hover {
      background-color: #218838;
      transform: translateY(-2px);
    }
    
    .decline-button {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 50rem;
      font-weight: 600;
      transition: all 0.3s ease;
      flex: 1;
    }
    
    .decline-button:hover {
      background-color: #c82333;
      transform: translateY(-2px);
    }
    
    .recent-consultations {
      margin-top: 2rem;
    }
    
    .recent-consultations h3 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: #2a2a2a;
    }
    
    .consultation-item {
      display: flex;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid #e9ecef;
      transition: all 0.3s ease;
    }
    
    .consultation-item:last-child {
      border-bottom: none;
    }
    
    .consultation-item:hover {
      background-color: #f8f9fa;
    }
    
    .consultation-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: #e9ecef;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      color: #0d6efd;
      margin-right: 1rem;
      font-weight: 600;
    }
    
    .consultation-info {
      flex: 1;
    }
    
    .consultation-info h4 {
      font-size: 1rem;
      margin-bottom: 0.25rem;
    }
    
    .consultation-info p {
      color: #6c757d;
      margin-bottom: 0;
      font-size: 0.875rem;
    }
    
    .consultation-time {
      color: #6c757d;
      font-size: 0.875rem;
    }
    
    .waiting-area.offline-mode {
      background-color: #fdf7e2;
      border: 2px dashed #ffc107;
      position: relative;
    }
    
    .waiting-area.offline-mode .waiting-icon {
      color: #ffc107;
    }
    
    .waiting-area.offline-mode::after {
      content: "OFFLINE MODE";
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #ffc107;
      color: #000;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.8rem;
    }
    
    .network-status {
      position: fixed;
      bottom: 10px;
      right: 10px;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: bold;
      z-index: 1000;
      display: none;
    }
    
    .network-status.online {
      background-color: #28a745;
      color: white;
      display: block;
    }
    
    .network-status.offline {
      background-color: #ffc107;
      color: black;
      display: block;
    }
    
    @media (max-width: 767.98px) {
      .action-buttons {
        flex-direction: column;
      }
    }
    
    .connection-status {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1000;
    }
    
    .status-indicator {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .status-indicator.online {
      background-color: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #81c784;
    }
    
    .status-indicator.offline {
      background-color: #ffebee;
      color: #c62828;
      border: 1px solid #ef9a9a;
    }
    
    .status-indicator.partial {
      background-color: #fff3e0;
      color: #ef6c00;
      border: 1px solid #ffb74d;
    }
    
    .status-indicator.disconnected {
      background-color: #fafafa;
      color: #616161;
      border: 1px solid #e0e0e0;
    }
    
    .offline-notification {
      margin-bottom: 15px;
    }
    
    .try-reconnect-btn {
      margin-left: 10px;
      background: transparent;
      border: 1px solid #856404;
      color: #856404;
      border-radius: 3px;
      padding: 2px 8px;
      cursor: pointer;
    }
    
    .try-reconnect-btn:hover {
      background-color: #856404;
      color: white;
    }
    
    /* Notification styles */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      max-width: 350px;
      z-index: 9999;
      display: none;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
      border-radius: 0.25rem;
      overflow: hidden;
    }
    
    .notification .toast {
      margin-bottom: 0;
    }
    
    .notification .toast-header {
      display: flex;
      align-items: center;
      padding: 0.5rem 0.75rem;
      background-clip: padding-box;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .notification .toast-body {
      padding: 0.75rem;
    }
    
    .notification .btn-close {
      padding: 0.25rem 0.5rem;
      background-color: transparent;
      border: 0;
      font-size: 1.25rem;
      font-weight: 700;
      line-height: 1;
      color: #000;
      text-shadow: 0 1px 0 #fff;
      opacity: 0.5;
      cursor: pointer;
    }
    
    .notification .btn-close:hover {
      color: #000;
      text-decoration: none;
      opacity: 0.75;
    }
  </style>
</head>

<body>
  <!-- Immediate script fix to prevent setupAvailabilityToggle reference error -->
  <script>
    // Direct monkey-patching to fix the problematic functions
    console.log("EMERGENCY FIX - Applying immediate function overrides");
    
    // Create safe fallback functions that will prevent errors
    window.setupAvailabilityToggle = function() {
      console.log("EMERGENCY FIX - Called setupAvailabilityToggle fallback");
    };
    
    // Override initializeUIElements if it already exists
    if (typeof window.initializeUIElements === 'function') {
      console.log("EMERGENCY FIX - Overriding existing initializeUIElements");
      window.originalInitUIElements = window.initializeUIElements;
      window.initializeUIElements = function() {
        console.log("EMERGENCY FIX - Called safe initializeUIElements");
      };
    }
    
    // Prepare to override it when it's defined later
    Object.defineProperty(window, 'initializeUIElements', {
      configurable: true,
      set: function(newFunction) {
        console.log("EMERGENCY FIX - Intercepted initializeUIElements definition");
        // Store the original function for debugging
        window.originalInitUIElements = newFunction;
        
        // Return a safe version that won't throw errors
        return function() {
          console.log("EMERGENCY FIX - Called safe initializeUIElements wrapper");
          try {
            // Setup availability toggle button directly
            console.log("EMERGENCY FIX - Setting up availability toggle");
            const toggleBtn = document.getElementById('status-toggle');
            if (toggleBtn) {
              toggleBtn.addEventListener('click', window.toggleAvailabilityClean || toggleAvailability);
            }
            
            // Setup timers for consultation requests
            console.log("EMERGENCY FIX - Setting up timers");
            const doctorId = "{{ session.get('user', {}).get('doctor_id', 'N/A') }}";
            window.requestInterval = setInterval(function() {
              if (typeof manualCheckForRequests === 'function') {
                manualCheckForRequests(doctorId);
              }
            }, 60000);
          } catch(e) {
            console.error("EMERGENCY FIX - Error in safe initializeUIElements:", e);
          }
        };
      },
      get: function() {
        return function() {
          console.log("EMERGENCY FIX - Called safe initializeUIElements getter");
          try {
            // Setup availability toggle button directly
            console.log("EMERGENCY FIX - Setting up availability toggle");
            const toggleBtn = document.getElementById('status-toggle');
            if (toggleBtn) {
              toggleBtn.addEventListener('click', window.toggleAvailabilityClean || toggleAvailability);
            }
            
            // Setup timers for consultation requests
            console.log("EMERGENCY FIX - Setting up timers");
            const doctorId = "{{ session.get('user', {}).get('doctor_id', 'N/A') }}";
            window.requestInterval = setInterval(function() {
              if (typeof manualCheckForRequests === 'function') {
                manualCheckForRequests(doctorId);
              }
            }, 60000);
          } catch(e) {
            console.error("EMERGENCY FIX - Error in safe initializeUIElements:", e);
          }
        };
      }
    });
    
    // Override setupFilterButtons
    window.setupFilterButtons = function() {
      console.log("EMERGENCY FIX - Called setupFilterButtons fallback");
    };
    
    // Override setupTimers
    window.setupTimers = function() {
      console.log("EMERGENCY FIX - Called setupTimers fallback");
    };
    
    // Override setupSortingButtons
    window.setupSortingButtons = function() {
      console.log("EMERGENCY FIX - Called setupSortingButtons fallback");
    };
    
    // Override setupRefreshButton
    window.setupRefreshButton = function() {
      console.log("EMERGENCY FIX - Called setupRefreshButton fallback");
    };
  </script>
  
  <!-- ======= Header ======= -->
  <header id="header" class="fixed-top">
    <div class="container d-flex align-items-center justify-content-between">
      <h1 class="logo"><img src="{{url_for('static', filename='logo.png')}}" alt="" class="src"><a href="/">Planical</a></h1>

      <nav id="navbar" class="navbar">
        <ul>
          <li><a class="nav-link" href="/">Home</a></li>
          <li><a class="nav-link active" href="/virtual-consultation">Video Consultation</a></li>
          <li><a class="nav-link" href="/profile">Profile</a></li>
          <li><a class="nav-link" href="/logout">Logout</a></li>
        </ul>
        <i class="bi bi-list mobile-nav-toggle"></i>
      </nav><!-- .navbar -->
    </div>
  </header><!-- End Header -->

  <!-- ======= Consultation Header ======= -->
  <section class="consultation-header">
    <div class="container">
      <div class="row">
        <div class="col-lg-8">
          <h1>Doctor Virtual Consultation</h1>
          <p class="mb-0">Provide mental health consultations to patients through secure video calls.</p>
        </div>
        <div class="col-lg-4 d-flex justify-content-end align-items-center">
          <span class="status-badge status-online me-2" id="status-badge">Available</span>
          <span id="status-text">You're available for consultations</span>
        </div>
      </div>
    </div>
  </section><!-- End Consultation Header -->

  <main id="main">
    <div class="container">
      <!-- Hidden inputs for JavaScript -->
      <input type="hidden" id="doctor-id" value="{{ session.get('user', {}).get('doctor_id', 'N/A') }}">
      <input type="hidden" id="doctor-name" value="{{ session.get('user', {}).get('name', 'Doctor') }}">
      
      <div class="row">
        <div class="col-lg-8">
          <!-- Waiting Area -->
          <div class="waiting-area">
            <i class="bi bi-broadcast waiting-icon"></i>
            <h3>Waiting for Patient Calls</h3>
            <p>You'll be notified when a patient requests a video consultation. Make sure your camera and microphone are enabled.</p>
            <button class="status-toggle active" id="status-toggle" onclick="toggleAvailability()">
              <i class="bi bi-check-circle-fill"></i>
              <span>Available for Consultations</span>
            </button>
          </div>

          <!-- Consultation Request (initially hidden) -->
          <div class="card mb-4" id="consultation-request-container">
            <div class="card-header">
              <i class="bi bi-bell-fill me-2"></i>Consultation Requests
            </div>
            <div class="card-body p-0" id="consultation-requests">
              <!-- Consultation requests will be inserted here -->
              <div class="text-center text-muted py-4" id="noRequestsMessage">
                <i class="bi bi-hourglass"></i>
                <p>No pending consultation requests</p>
                <p class="small text-muted">Requests will appear here when patients need your assistance</p>
              </div>
            </div>
          </div>

          <!-- Recent Consultations -->
          <div class="card recent-consultations">
            <div class="card-header">
              <i class="bi bi-clock-history me-2"></i>Recent Consultations
            </div>
            <div class="card-body">
              <!-- Sample recent consultations, will be dynamically populated in a real app -->
              <div class="consultation-item">
                <div class="consultation-avatar">R</div>
                <div class="consultation-info">
                  <h4>Rahul Sharma</h4>
                  <p>Consultation for anxiety symptoms</p>
                </div>
                <div class="consultation-time">Yesterday</div>
              </div>
              <div class="consultation-item">
                <div class="consultation-avatar">P</div>
                <div class="consultation-info">
                  <h4>Priya Patel</h4>
                  <p>Follow-up consultation for depression</p>
                </div>
                <div class="consultation-time">2 days ago</div>
              </div>
              <div class="consultation-item">
                <div class="consultation-avatar">A</div>
                <div class="consultation-info">
                  <h4>Amit Verma</h4>
                  <p>Initial consultation for stress management</p>
                </div>
                <div class="consultation-time">5 days ago</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-lg-4">
          <!-- Doctor Profile -->
          <div class="card mb-4">
            <div class="card-header">
              <i class="bi bi-person-badge-fill me-2"></i>Your Profile
            </div>
            <div class="card-body text-center">
              <div style="width: 100px; height: 100px; border-radius: 50%; background-color: #0d6efd; color: white; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; margin: 0 auto 1.5rem;">
                D
              </div>
              <h4>Dr. {{ session.get('user', {}).get('name', 'Doctor') }}</h4>
              <p class="mb-2">Mental Health Specialist</p>
              <p class="mb-3"><i class="bi bi-award-fill me-2"></i>ID: {{ session.get('user', {}).get('doctor_id', 'N/A') }}</p>
              <hr>
              <div class="d-flex justify-content-between">
                <div>
                  <p class="mb-0 fw-bold">12</p>
                  <p class="text-muted small">Consultations Today</p>
                </div>
                <div>
                  <p class="mb-0 fw-bold">86</p>
                  <p class="text-muted small">Total Consultations</p>
                </div>
                <div>
                  <p class="mb-0 fw-bold">4.9</p>
                  <p class="text-muted small">Rating</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Guidelines -->
          <div class="card mb-4">
            <div class="card-header">
              <i class="bi bi-list-check me-2"></i>Consultation Guidelines
            </div>
            <div class="card-body">
              <ul class="list-unstyled">
                <li class="mb-3"><i class="bi bi-check-circle-fill text-success me-2"></i>Ensure patient confidentiality at all times</li>
                <li class="mb-3"><i class="bi bi-check-circle-fill text-success me-2"></i>Use a professional background during calls</li>
                <li class="mb-3"><i class="bi bi-check-circle-fill text-success me-2"></i>Wear appropriate professional attire</li>
                <li class="mb-3"><i class="bi bi-check-circle-fill text-success me-2"></i>Take notes during and after consultations</li>
                <li><i class="bi bi-check-circle-fill text-success me-2"></i>Follow up with patients as needed</li>
              </ul>
              <hr>
              <p class="small text-muted mb-0">For more detailed guidelines, please refer to the <a href="#" class="text-decoration-none">Doctor's Handbook</a>.</p>
            </div>
          </div>
          
          <!-- Support -->
          <div class="card">
            <div class="card-header">
              <i class="bi bi-headset me-2"></i>Technical Support
            </div>
            <div class="card-body">
              <p>If you're experiencing technical difficulties during consultations, please contact our support team.</p>
              <p><i class="bi bi-envelope-fill me-2"></i>Email: support@planical.com</p>
              <p class="mb-0"><i class="bi bi-telephone-fill me-2"></i>Phone: +91 901 9708133</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- ======= Footer ======= -->
  <footer id="footer" style="background-color: #f8f9fa; padding: 30px 0; text-align: center; margin-top: 3rem;">
    <div class="container">
      <div class="copyright">
        &copy; Copyright <strong><span>Planical</span></strong>. All Rights Reserved
      </div>
      <div class="credits">
        Doctor Consultation Platform
      </div>
    </div>
  </footer><!-- End Footer -->

  <!-- Notification Element -->
  <div class="notification">
    <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto">Notification</strong>
        <button type="button" class="btn-close" onclick="document.querySelector('.notification').style.display='none'"></button>
      </div>
      <div class="toast-body">
        <!-- Notification message goes here -->
      </div>
    </div>
  </div>

  <!-- Vendor JS Files -->
  <script src="{{url_for('static', filename='assets/vendor/bootstrap/js/bootstrap.bundle.min.js')}}"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  
  <!-- Firebase required libraries -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  
  <!-- Connection status manager -->
  <script src="{{url_for('static', filename='js/connection_status.js')}}"></script>
  
  <!-- Add firebase configuration script -->
  <script>
    // Debug Firebase configuration
    console.log("Firebase config debug:", {
      apiKey: "{{ firebase_config.apiKey }}",
      authDomain: "{{ firebase_config.authDomain }}",
      projectId: "{{ firebase_config.projectId }}",
      storageBucket: "{{ firebase_config.storageBucket }}",
      messagingSenderId: "{{ firebase_config.messagingSenderId }}",
      appId: "{{ firebase_config.appId }}",
      databaseURL: "{{ firebase_config.databaseURL }}"
    });
    
    // Firebase settings to help avoid connection errors
    const FIREBASE_SETTINGS = {
      cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED,
      experimentalForceLongPolling: true, 
      experimentalAutoDetectLongPolling: false,
      useFetchStreams: false,
      ignoreUndefinedProperties: true
    };
    
    // Function to initialize Firebase with proper error handling
    function initializeFirebase() {
      return new Promise((resolve, reject) => {
        try {
          // Check if Firebase JS is loaded
          if (typeof firebase === 'undefined') {
            console.error("Firebase SDK not loaded");
            
            // Try to load the Firebase scripts
            const firebaseScripts = [
              "https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js",
              "https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js",
              "https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"
            ];
            
            let loadedCount = 0;
            firebaseScripts.forEach(src => {
              const script = document.createElement('script');
              script.src = src;
              script.onload = () => {
                loadedCount++;
                if (loadedCount === firebaseScripts.length) {
                  console.log("Firebase scripts loaded successfully, retrying initialization");
                  // Slight delay to ensure scripts are fully processed
                  setTimeout(() => initializeFirebase().then(resolve).catch(reject), 500);
                }
              };
              script.onerror = () => {
                console.error(`Failed to load Firebase script: ${src}`);
                reject(new Error("Firebase SDK could not be loaded"));
              };
              document.head.appendChild(script);
            });
            
            return; // Exit and wait for scripts to load
          }
          
          // Check if already initialized
          if (firebase.apps && firebase.apps.length > 0) {
            console.log("Firebase already initialized");
            
            try {
              // Apply settings to help with connection issues
              const db = firebase.firestore();
              db.settings(FIREBASE_SETTINGS);
              console.log("Applied enhanced settings to existing Firebase instance");
            } catch (settingErr) {
              console.warn("Could not apply settings to existing Firebase instance:", settingErr);
            }
            
            resolve(true);
            return;
          }
          
          // Get firebase config with safeguards
          const firebaseConfig = {
            apiKey: "{{ firebase_config.apiKey }}" || "",
            authDomain: "{{ firebase_config.authDomain }}" || "",
            projectId: "{{ firebase_config.projectId }}" || "",
            storageBucket: "{{ firebase_config.storageBucket }}" || "",
            messagingSenderId: "{{ firebase_config.messagingSenderId }}" || "",
            appId: "{{ firebase_config.appId }}" || "",
            databaseURL: "{{ firebase_config.databaseURL }}" || ""
          };
          
          // Log project ID for debugging
          console.log("Firebase config loaded - Project ID:", firebaseConfig.projectId || "MISSING");
          
          // Validate essential config properties
          const missingProps = [];
          if (!firebaseConfig.apiKey) missingProps.push("apiKey");
          if (!firebaseConfig.projectId) missingProps.push("projectId");
          
          if (missingProps.length > 0) {
            // Create a usable mock Firebase object that will not error out the app
            console.warn(`Firebase configuration incomplete - missing: ${missingProps.join(", ")}`);
            showNotification("Limited functionality mode", "Database connection is not properly configured", "warning");
            
            // Create a mock Firebase implementation
            setupMockFirebase();
            resolve(false);
            return;
          }
          
          // Initialize Firebase with the config
          firebase.initializeApp(firebaseConfig);
          console.log("Firebase initialized with long polling transport to avoid WebChannel errors");
          
          // Apply settings that help avoid HTTP 400 errors
          const db = firebase.firestore();
          try {
            db.settings(FIREBASE_SETTINGS);
            console.log("Applied enhanced Firestore settings to prevent WebChannel errors");
          } catch (err) {
            console.warn("Could not apply Firestore settings:", err);
          }
          
          // Connection test function with better error handling
          const connectionTest = async () => {
            console.log("Firebase connection test starting");
            
            try {
              // First check if we have a Firebase Auth user
              const currentUser = firebase.auth().currentUser;
              if (!currentUser) {
                console.log("No Firebase Auth user - attempting anonymous auth");
                try {
                  // Try anonymous sign in for read-only access
                  await firebase.auth().signInAnonymously();
                  console.log("Anonymous auth successful");
                } catch (authErr) {
                  console.warn("Anonymous auth failed, continuing with limited permissions:", authErr);
                }
              }
              
              // Use a simple document read instead of write to test permissions
              // This is more likely to succeed with limited permissions
              const testDocRef = db.collection('connection_tests').doc('read_test');
              
              // Try a simple get operation instead of set
              try {
                await testDocRef.get();
                console.log("Firebase read test successful");
                return true;
              } catch (readErr) {
                console.warn("Firebase read test failed:", readErr);
                
                // Check if it's a permission error
                if (String(readErr).includes("permission") || String(readErr).includes("Missing or insufficient permissions")) {
                  console.log("Permission issue detected - will try alternative path");
                  
                  // Try to connect to a public collection that should be readable
                  try {
                    const publicRef = db.collection('public_data').doc('status');
                    await publicRef.get();
                    console.log("Alternative Firebase path successful");
                    return true;
                  } catch (pubErr) {
                    console.warn("Alternative Firebase path also failed:", pubErr);
                  }
                }
              }
              
              // Fix WebChannel errors regardless of the test result
              console.log("Applying WebChannel fixes regardless of test result");
              db.settings({
                ...FIREBASE_SETTINGS,
                experimentalForceLongPolling: true,
                experimentalAutoDetectLongPolling: false,
                useFetchStreams: false
              });
              console.log("Applied enhanced Firestore settings to prevent WebChannel errors");
              
              return true;
            } catch (err) {
              console.warn("Firebase connection test failed:", err);
              
              // Try to fix common issues
              const errString = String(err);
              if (errString.includes("WebChannel") || errString.includes("400")) {
                console.log("Detected WebChannel error, applying additional fixes");
                
                // More aggressive settings to avoid WebChannel errors
                try {
                  db.settings({
                    ...FIREBASE_SETTINGS,
                    experimentalForceLongPolling: true,
                    experimentalAutoDetectLongPolling: false,
                    experimentalLongPollingOptions: {
                      timeoutSeconds: 30,
                      keepAliveSeconds: 5
                    },
                    useFetchStreams: false
                  });
                  console.log("Applied more aggressive settings to fix WebChannel issues");
                } catch (fixErr) {
                  console.warn("Failed to apply WebChannel fixes:", fixErr);
                }
              }
              
              // Still resolve, we'll use the REST API as fallback
              return false;
            }
          };
          
          // Wait a bit for Firebase to settle then test connection
          setTimeout(async () => {
            const success = await connectionTest();
            
            if (success) {
              resolve(true);
            } else {
              // We'll still resolve but indicate there are issues
              console.log("Will use alternative methods due to connection issues");
              resolve(false);
            }
          }, 1000);
        } catch (error) {
          console.error("Error during Firebase initialization:", error);
          showNotification("Database connection error", "Working in limited functionality mode", "warning");
          setupMockFirebase();
          reject(error);
        }
      });
    }
    
    // Function to set up a mock Firebase implementation when config is missing
    function setupMockFirebase() {
      if (typeof firebase === 'undefined' || firebase.apps.length === 0) {
        console.log("Setting up mock Firebase for offline/limited functionality mode");
        
        // Create a minimal mock Firebase implementation
        window.firebase = window.firebase || {};
        firebase.apps = [];
        
        // Mock app
        firebase.initializeApp = () => {
          const mockApp = {
            name: "[mock-app]"
          };
          firebase.apps.push(mockApp);
          return mockApp;
        };
        
        firebase.app = () => {
          if (firebase.apps.length === 0) {
            return firebase.initializeApp();
          }
          return firebase.apps[0];
        };
        
        // Mock firestore
        firebase.firestore = () => {
          const mockDb = {
            collection: (name) => ({
              doc: (id) => ({
                get: () => Promise.reject(new Error("Mock Firebase - offline mode")),
                set: () => Promise.reject(new Error("Mock Firebase - offline mode")),
                update: () => Promise.reject(new Error("Mock Firebase - offline mode"))
              }),
              where: () => ({
                get: () => Promise.resolve({ empty: true, docs: [] }),
                onSnapshot: (callback) => {
                  callback({ empty: true, docs: [] });
                  return () => {}; // Unsubscribe function
                }
              }),
              get: () => Promise.resolve({ empty: true, docs: [] })
            }),
            settings: () => {},
            enablePersistence: () => Promise.resolve(),
            enableNetwork: () => Promise.resolve(),
            disableNetwork: () => Promise.resolve()
          };
          return mockDb;
        };
        
        // Mock constants
        firebase.firestore.CACHE_SIZE_UNLIMITED = 'unlimited';
        firebase.firestore.FieldValue = {
          serverTimestamp: () => new Date()
        };
        
        // Mock database
        firebase.database = () => ({
          ref: (path) => ({
            on: (event, callback) => {
              if (path === '.info/connected') {
                callback({ val: () => false });
              }
              return () => {}; // Unsubscribe function
            },
            off: () => {},
            once: () => Promise.resolve({ val: () => false })
          })
        });
        
        console.log("Mock Firebase setup complete - app will work in limited functionality mode");
      }
    }
  </script>
  
  <!-- Socket.IO Connection and Event Handlers - Complete Rewrite Version 2025-04-19-v6 -->
  <script>
    // VERSION INDICATOR - 2025-04-19-v7 - Fixed missing function definitions
    console.log("COMPLETE REWRITE - Socket.IO Connection and Event Handlers v7");
    
    // Define missing functions first to prevent reference errors
    function safeUISetup() {
      try {
        console.log("Setting up UI elements - SAFE REWRITE v7");
        
        // Setup toggle button
        const toggleBtn = document.getElementById('status-toggle');
        if (toggleBtn) {
          // Remove existing listeners
          const newToggleBtn = toggleBtn.cloneNode(true);
          toggleBtn.parentNode.replaceChild(newToggleBtn, toggleBtn);
          
          // Add safe listener
          newToggleBtn.addEventListener('click', function() {
            if (typeof window.toggleAvailabilityClean === 'function') {
              window.toggleAvailabilityClean();
            } else if (typeof toggleAvailability === 'function') {
              toggleAvailability();
            } else {
              console.error("No toggle availability function found");
            }
          });
        }
        
        // Setup periodic request check
        const doctorId = document.getElementById('doctor-id')?.value || 
                        "{{ session.get('user', {}).get('doctor_id', 'N/A') }}";
        
        if (!window.requestCheckInterval) {
          window.requestCheckInterval = setInterval(function() {
            if (typeof manualCheckForRequests === 'function') {
              manualCheckForRequests(doctorId);
            }
          }, 60000);
        }
        
        // Update last check time
        const waitingArea = document.querySelector('.waiting-area');
        if (waitingArea && !document.getElementById('lastCheckTime')) {
          const timeEl = document.createElement('p');
          timeEl.className = 'text-muted mt-3 small';
          timeEl.innerHTML = 'Last checked: <span id="lastCheckTime">Just now</span>';
          waitingArea.appendChild(timeEl);
          
          if (typeof updateLastCheckTime === 'function') {
            updateLastCheckTime();
          }
        }
      } catch (error) {
        console.error("Error setting up UI - SAFE REWRITE:", error);
      }
    }
    
    function safeUpdateSocketStatus(status, message) {
      try {
        console.log("Safe status update - SAFE REWRITE v7:", status, message);
        
        // Try to use the existing function if it exists
        if (typeof updateSocketStatus === 'function') {
          updateSocketStatus(status, message);
          return;
        }
        
        // Create or get status indicator
        let statusIndicator = document.querySelector('.connection-status');
        if (!statusIndicator) {
          statusIndicator = document.createElement('div');
          statusIndicator.className = 'connection-status';
          
          const indicator = document.createElement('div');
          indicator.className = 'status-indicator';
          
          statusIndicator.appendChild(indicator);
          document.body.appendChild(statusIndicator);
        }
        
        // Update indicator
        const indicator = statusIndicator.querySelector('.status-indicator');
        if (indicator) {
          // Reset classes
          indicator.className = 'status-indicator';
          
          // Set class based on status
          if (status === 'Online' || status === 'Connected') {
            indicator.classList.add('online');
          } else if (status === 'Offline') {
            indicator.classList.add('offline');
          } else if (status === 'Partial' || status === 'Limited') {
            indicator.classList.add('partial');
          } else {
            indicator.classList.add('disconnected');
          }
          
          // Set content
          indicator.innerHTML = `<i class="bi ${status === 'Online' || status === 'Connected' ? 'bi-wifi' : 'bi-wifi-off'}"></i> ${status}: ${message || ''}`;
        }
      } catch (error) {
        console.error("Error updating socket status - SAFE REWRITE:", error);
      }
    }
    
    function safeShowNotification(message, type) {
      try {
        console.log("Safe notification - SAFE REWRITE v7:", message, type);
        
        // Try to use the existing function first
        if (typeof showNotification === 'function') {
          showNotification(message, type);
          return;
        }
        
        // Fallback implementation
        const notification = document.querySelector('.notification');
        if (!notification) return;
        
        const msgElement = notification.querySelector('.toast-body');
        if (!msgElement) return;
        
        // Set message
        msgElement.textContent = message;
        
        // Set style based on type
        const toast = notification.querySelector('.toast');
        if (toast) {
          toast.className = 'toast show';
          
          if (type === 'success') {
            toast.classList.add('bg-success', 'text-white');
          } else if (type === 'error') {
            toast.classList.add('bg-danger', 'text-white');
          } else if (type === 'warning') {
            toast.classList.add('bg-warning');
          } else {
            toast.classList.add('bg-info', 'text-white');
          }
        }
        
        // Show notification
        notification.style.display = 'block';
        
        // Auto-hide after 5 seconds
        setTimeout(function() {
          notification.style.display = 'none';
        }, 5000);
      } catch (error) {
        console.error("Error showing notification - SAFE REWRITE:", error);
      }
    }
    
    // Wait for DOM to be ready
    document.addEventListener('DOMContentLoaded', function() {
      console.log("DOM loaded - SAFE REWRITE v7 - initializing components...");
      
      // Set up Firebase with a timeout
      let fbInitialized = false;
      let fbTimeoutId = setTimeout(function() {
        if (!fbInitialized) {
          console.warn("Firebase init timed out - using limited functionality");
          // Set up Socket.IO
          safeSocketSetup();
          // Set up UI elements
          safeUISetup();
        }
      }, 5000);
      
      // Try to initialize Firebase
      safeInitFirebase().then(function(success) {
        fbInitialized = true;
        clearTimeout(fbTimeoutId);
        
        if (success) {
          console.log("Firebase initialized successfully - SAFE REWRITE");
          
          // Set up connection manager
          safeSetupConnectionManager();
        } else {
          console.warn("Firebase initialization had issues - SAFE REWRITE");
        }
        
        // Set up Socket.IO
        safeSocketSetup();
        // Set up UI elements
        safeUISetup();
      }).catch(function(error) {
        console.error("Firebase initialization failed - SAFE REWRITE:", error);
        fbInitialized = false;
        clearTimeout(fbTimeoutId);
        
        // Set up Socket.IO
        safeSocketSetup();
        // Set up UI elements
        safeUISetup();
      });
    });
    
    // Rest of your existing code...
  </script>

  <!-- Simple API-based fallback function to get consultation requests -->
  <script>
    // VERSION INDICATOR - 2025-04-19-v4 - Changes to fix setupAvailabilityToggle reference error
    console.log("Loading doctor_view.html (VERSION 2025-04-19-v4) - Connection Manager Integration");
    
    // Add a variable to track last check time
    let lastCheckTime = new Date();
    
    // Function to update the last check time
    function updateLastCheckTime() {
      lastCheckTime = new Date();
      console.log("Updated last check time:", lastCheckTime.toLocaleTimeString());
      
      // Update UI if element exists
      const lastCheckElement = document.getElementById('lastCheckTime');
      if (lastCheckElement) {
        lastCheckElement.textContent = lastCheckTime.toLocaleTimeString();
      }
    }
    
    function fetchRequestsViaAPI(doctorId) {
      console.log("Fetching consultation requests via direct API endpoint");
      updateSocketStatus('Fetching via API...', 'yellow');
      
      return fetch(`/api/doctor-requests/${doctorId}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`API error: ${response.status} ${response.statusText}`);
          }
          return response.json();
        })
        .then(requests => {
          updateLastCheckTime();
          console.log(`Found ${requests.length} pending requests via API`);
          
          if (requests.length === 0) {
            showNotification('No pending requests found', 'info');
            updateSocketStatus('Connected', 'No pending requests');
            return 0;
          }
          
          // Process the requests
          let count = 0;
          requests.forEach(requestData => {
            console.log('Processing API request:', requestData);
            displayConsultationRequest(requestData);
            count++;
          });
          
          updateSocketStatus('Connected', `Found ${count} requests via API`);
          showNotification(`Found ${count} consultation request(s)`, 'success');
          return count;
        })
        .catch(error => {
          console.error('Error fetching via API:', error);
          updateSocketStatus('Error', 'Could not fetch requests');
          showNotification('Error checking for requests: Connection issues detected', 'error');
          return 0;
        });
    }
  </script>

  <script>
    function checkPendingConsultations(doctorId) {
      console.log("Checking pending consultations for doctor:", doctorId);
      
      // First, check if we appear to be online
      if (window.connectionManager && typeof window.connectionManager.isOnline === 'function' && !window.connectionManager.isOnline()) {
        console.log("Device appears to be offline, can't check for consultations");
        updateSocketStatus('Offline', 'Cannot check for requests while offline');
        return Promise.resolve(0);
      }
      
      // Try multiple approaches to fetch requests, starting with direct Firestore
      // but have robust fallbacks for permission issues
      return new Promise((resolve) => {
        // Use a timeout to ensure we don't hang if Firebase is slow
        const timeoutId = setTimeout(() => {
          console.log("Firestore query timed out, using API fallback");
          fetchRequestsViaAPI(doctorId).then(resolve);
        }, 5000);
        
        if (typeof firebase !== 'undefined' && firebase.firestore) {
          console.log("Using direct Firestore query");
          try {
            const db = firebase.firestore();
            
            // Try to use the consultations collection first
            db.collection('consultations')
              .where('status', '==', 'pending')
              .where('doctor_id', '==', doctorId)
              .get()
              .then(querySnapshot => {
                clearTimeout(timeoutId);
                
                if (querySnapshot.empty) {
                  console.log("No pending consultations found in Firestore");
                  resolve(0);
                  return;
                }
                
                let count = 0;
                querySnapshot.forEach(doc => {
                  const requestData = doc.data();
                  requestData.consultationId = doc.id;
                  displayConsultationRequest(requestData);
                  count++;
                });
                
                console.log(`Found ${count} pending consultations in Firestore`);
                resolve(count);
              })
              .catch(error => {
                console.warn("Error checking pending consultations in Firestore:", error);
                
                // Handle permission errors specifically
                if (String(error).includes("permission") || String(error).includes("Missing or insufficient permissions")) {
                  console.log("Permission error detected, trying public collection");
                  
                  // Try a potentially more public collection as fallback
                  db.collection('public_consultations')
                    .where('status', '==', 'pending')
                    .where('doctor_id', '==', doctorId)
                    .get()
                    .then(publicSnapshot => {
                      clearTimeout(timeoutId);
                      
                      if (publicSnapshot.empty) {
                        console.log("No pending consultations found in public collection");
                        // Try API as another fallback
                        return fetchRequestsViaAPI(doctorId).then(resolve);
                      }
                      
                      let count = 0;
                      publicSnapshot.forEach(doc => {
                        const requestData = doc.data();
                        requestData.consultationId = doc.id;
                        displayConsultationRequest(requestData);
                        count++;
                      });
                      
                      console.log(`Found ${count} pending consultations in public collection`);
                      resolve(count);
                    })
                    .catch(publicError => {
                      console.warn("Error checking public collection:", publicError);
                      clearTimeout(timeoutId);
                      // Fall back to API
                      fetchRequestsViaAPI(doctorId).then(resolve);
                    });
                } else {
                  // For other errors, use API fallback
                  clearTimeout(timeoutId);
                  fetchRequestsViaAPI(doctorId).then(resolve);
                }
              });
          } catch (error) {
            console.error("Error setting up Firestore query:", error);
            clearTimeout(timeoutId);
            // Fall back to API
            fetchRequestsViaAPI(doctorId).then(resolve);
          }
        } else {
          console.log("Firebase not available, using direct API fallback");
          clearTimeout(timeoutId);
          fetchRequestsViaAPI(doctorId).then(resolve);
        }
      });
    }
  </script>

  <!-- Notification and Status Handling Functions -->
  <script>
    // Show notification function
    function showNotification(message, type) {
      console.log("Showing notification:", message, "Type:", type);
      const notification = document.querySelector('.notification');
      const notificationMessage = document.querySelector('.notification .toast-body');
      
      if (!notification || !notificationMessage) {
        console.error("Notification elements not found in DOM");
        return;
      }
      
      // Set message
      notificationMessage.textContent = message;
      
      // Set background color based on type
      const toast = notification.querySelector('.toast');
      toast.className = 'toast show';
      
      if (type === 'success') {
        toast.classList.add('bg-success', 'text-white');
      } else if (type === 'error') {
        toast.classList.add('bg-danger', 'text-white');
      } else if (type === 'warning') {
        toast.classList.add('bg-warning');
      } else {
        toast.classList.add('bg-info', 'text-white');
      }
      
      // Show notification
      notification.style.display = 'block';
      
      // Auto-hide after 5 seconds
      setTimeout(function() {
        notification.style.display = 'none';
      }, 5000);
    }
    
    // Update socket connection status display
    function updateSocketStatus(status, message, color) {
      console.log(`Socket/Connection status update: ${status} - ${message}`);
      
      // Create status indicator if it doesn't exist
      let statusIndicator = document.querySelector('.connection-status');
      if (!statusIndicator) {
        statusIndicator = document.createElement('div');
        statusIndicator.className = 'connection-status';
        
        const indicator = document.createElement('div');
        indicator.className = 'status-indicator';
        
        statusIndicator.appendChild(indicator);
        document.body.appendChild(statusIndicator);
      }
      
      // Update the indicator
      const indicator = statusIndicator.querySelector('.status-indicator');
      if (indicator) {
        // Reset classes
        indicator.className = 'status-indicator';
        
        // Set class based on status
        if (status === 'Online' || status === 'Connected') {
          indicator.classList.add('online');
        } else if (status === 'Offline') {
          indicator.classList.add('offline');
        } else if (status === 'Partial' || status === 'Limited') {
          indicator.classList.add('partial');
        } else {
          indicator.classList.add('disconnected');
        }
        
        // Set content
        indicator.innerHTML = `<i class="bi ${status === 'Online' || status === 'Connected' ? 'bi-wifi' : 'bi-wifi-off'}"></i> ${status}: ${message}`;
      }
    }
  </script>

  <!-- Function to initialize Socket.IO for the doctor view -->
  <script>
    function initializeSocketIO() {
      console.log("Initializing Socket.IO for doctor view");
      
      try {
        // Create socket connection - ensure it's globally available
        window.socket = io();
        
        // Always use window.socket for consistency
        const socket = window.socket;
        
        // Get doctor information
        const userId = "{{ session.get('user', {}).get('doctor_id', 'N/A') }}";
        const userName = "{{ session.get('user', {}).get('name', 'Doctor') }}";
        console.log("Doctor info:", { userId, userName });
        
        // Register for doctor-specific events
        console.log(`Registering for doctor-specific event: new-consultation-request-${userId}`);
        
        // Handle connection events
        window.socket.on('connect', function() {
          console.log("Socket.IO connected successfully");
          
          // Send doctor information to server
          const doctorInfo = {
            doctorId: userId,
            doctorName: userName,
            userRole: 'doctor'
          };
          
          window.socket.emit('doctor-connect', doctorInfo);
          console.log("Doctor info sent to server:", doctorInfo);
          
          // Update UI
          safeUpdateSocketStatus('Connected', 'Real-time connection established');
        });
        
        window.socket.on('disconnect', function() {
          console.log("Socket.IO disconnected");
          safeUpdateSocketStatus('Disconnected', 'Real-time connection lost');
          
          // If we have a connection manager, let it handle reconnection logic
          if (window.connectionManager && typeof window.connectionManager.checkConnection === 'function') {
            window.connectionManager.checkConnection();
          }
        });
        
        // Listen for new consultation requests
        window.socket.on(`new-consultation-request-${userId}`, function(data) {
          console.log("Received new consultation request:", data);
          
          // Show notification
          showNotification("New consultation request received", "info");
          
          // Display the request in UI
          if (typeof displayConsultationRequest === 'function') {
            displayConsultationRequest(data);
          } else {
            console.error("displayConsultationRequest function not defined");
          }
        });
        
        // Make socket available globally
        window.socket = socket;
        
        // Add any other event listeners needed for the doctor view
      } catch (err) {
        console.error("Error in initializeSocketIO:", err);
      }
    }
  </script>

  <script>
    // Function to display a consultation request in the UI
    function displayConsultationRequest(requestData) {
      console.log("Displaying consultation request:", requestData);
      
      try {
        // Get the container where requests will be displayed
        const requestsContainer = document.getElementById('consultation-requests');
        const noRequestsMessage = document.getElementById('noRequestsMessage');
        
        if (!requestsContainer) {
          console.error("Consultation requests container not found");
          return;
        }
        
        // Hide the "no requests" message if it exists
        if (noRequestsMessage) {
          noRequestsMessage.style.display = 'none';
        }
        
        // Check if this request is already displayed
        const existingRequest = document.getElementById(`request-${requestData.consultationId}`);
        if (existingRequest) {
          console.log("Request already displayed, updating it");
          // Update the existing request (could add more sophisticated updating logic here)
          return;
        }
        
        // Create a new request element
        const requestElement = document.createElement('div');
        requestElement.className = 'consultation-request p-3 mb-3 border-left border-primary';
        requestElement.id = `request-${requestData.consultationId}`;
        
        // Get formatted date and time
        const requestDate = new Date(requestData.timestamp || Date.now());
        const formattedDate = requestDate.toLocaleString();
        
        // Get patient initials for avatar
        const patientName = requestData.patient_name || 'Patient';
        const initials = patientName.split(' ').map(n => n[0]).join('').toUpperCase();
        
        // Set inner HTML with request details
        requestElement.innerHTML = `
          <div class="patient-info">
            <div class="patient-avatar">${initials}</div>
            <div class="patient-details">
              <h4>${patientName}</h4>
              <p>Requested: ${formattedDate}</p>
            </div>
          </div>
          <div class="mb-3">
            <strong>Symptoms:</strong>
            <p>${requestData.symptoms || 'Not specified'}</p>
          </div>
          <div class="mb-3">
            <strong>Urgency:</strong>
            <span class="badge ${requestData.urgency === 'high' ? 'bg-danger' : requestData.urgency === 'medium' ? 'bg-warning' : 'bg-info'} text-white">
              ${requestData.urgency || 'Normal'}
            </span>
          </div>
          <div class="action-buttons">
            <button class="accept-button" onclick="acceptConsultation('${requestData.consultationId}')">
              <i class="bi bi-check-circle-fill me-2"></i>Accept Request
            </button>
            <button class="decline-button" onclick="declineConsultation('${requestData.consultationId}')">
              <i class="bi bi-x-circle-fill me-2"></i>Decline
            </button>
          </div>
        `;
        
        // Add to the container
        requestsContainer.prepend(requestElement);
        
        // Show the container
        document.getElementById('consultation-request-container').style.display = 'block';
        
        // Play notification sound if available
        const notificationSound = document.getElementById('notificationSound');
        if (notificationSound) {
          notificationSound.play().catch(e => console.log("Could not play notification sound:", e));
        }
      } catch (error) {
        console.error("Error displaying consultation request:", error);
      }
    }
    
    // Functions to accept or decline consultation requests
    function acceptConsultation(consultationId) {
      console.log("Accepting consultation:", consultationId);
      
      // Show processing state
      const acceptButton = document.querySelector(`#request-${consultationId} .accept-button`);
      if (acceptButton) {
        acceptButton.disabled = true;
        acceptButton.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Processing...';
      }
      
      // Emit socket event to accept the consultation
      if (window.socket) {
        window.socket.emit('accept-consultation', {
          consultationId: consultationId,
          doctorId: "{{ session.get('user', {}).get('doctor_id', 'N/A') }}"
        });
      }
      
      // Redirect to the video call page
      setTimeout(() => {
        window.location.href = `/doctor-video-call/${consultationId}`;
      }, 1000);
    }
    
    function declineConsultation(consultationId) {
      console.log("Declining consultation:", consultationId);
      
      // Get reason (could add a modal for this)
      const reason = prompt("Please provide a reason for declining:", "Not available at this time");
      
      if (reason === null) {
        // User canceled the prompt
        return;
      }
      
      // Show processing state
      const declineButton = document.querySelector(`#request-${consultationId} .decline-button`);
      if (declineButton) {
        declineButton.disabled = true;
        declineButton.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Processing...';
      }
      
      // Emit socket event to decline the consultation
      if (window.socket) {
        window.socket.emit('decline-consultation', {
          consultationId: consultationId,
          doctorId: "{{ session.get('user', {}).get('doctor_id', 'N/A') }}",
          reason: reason
        });
      }
      
      // Remove the request from the UI
      setTimeout(() => {
        const requestElement = document.getElementById(`request-${consultationId}`);
        if (requestElement) {
          requestElement.remove();
        }
        
        // Check if there are any remaining requests
        const requestsContainer = document.getElementById('consultation-requests');
        if (requestsContainer && !requestsContainer.querySelector('.consultation-request')) {
          // No requests left, show the "no requests" message
          const noRequestsMessage = document.getElementById('noRequestsMessage');
          if (noRequestsMessage) {
            noRequestsMessage.style.display = 'block';
          }
        }
      }, 500);
    }
  </script>

  <script>
    // Function to manually check for pending consultation requests
    function manualCheckForRequests(doctorId) {
      console.log("Manually checking for pending consultation requests");
      
      // Show checking indicator
      updateSocketStatus('Checking', 'Looking for pending requests...');
      
      // Check if we're online before making any requests
      if (window.connectionManager && typeof window.connectionManager.isOnline === 'function' && !window.connectionManager.isOnline()) {
        console.log("Device appears to be offline, skipping request check");
        updateSocketStatus('Offline', 'Cannot check for requests while offline');
        return Promise.resolve(0);
      }
      
      // Use the checkPendingConsultations function
      return checkPendingConsultations(doctorId)
        .then(count => {
          console.log(`Manual check complete. Found ${count} pending requests.`);
          
          // Update UI based on results
          if (count > 0) {
            updateSocketStatus('Found Requests', `${count} pending requests found`);
          } else {
            updateSocketStatus('No Requests', 'No pending requests at this time');
          }
          
          return count;
        })
        .catch(error => {
          console.error("Error during manual check:", error);
          updateSocketStatus('Error', 'Error checking for requests');
          return 0;
        });
    }
  </script>

  <!-- Final error checking and recovery -->
  <script>
    // Run this after all scripts are loaded to detect and fix any missing functions
    document.addEventListener('DOMContentLoaded', function() {
      // Ensure socket is globally available
      setTimeout(function() {
        if (typeof socket === 'undefined' && typeof window.socket !== 'undefined') {
          console.log("Making socket globally available");
          window.socket = window.socket;
          socket = window.socket;
        }
        
        // Run an initial check for requests if we're online
        if (typeof manualCheckForRequests === 'function') {
          const doctorId = "{{ session.get('user', {}).get('doctor_id', 'N/A') }}";
          console.log("Performing initial check for requests");
          manualCheckForRequests(doctorId);
        }
        
        // Add a last-check element to show last update time
        const waitingArea = document.querySelector('.waiting-area');
        if (waitingArea && !document.getElementById('lastCheckTime')) {
          const lastCheckElement = document.createElement('p');
          lastCheckElement.className = 'text-muted mt-3 small';
          lastCheckElement.innerHTML = 'Last checked: <span id="lastCheckTime">Just now</span>';
          waitingArea.appendChild(lastCheckElement);
          updateLastCheckTime();
        }
      }, 2000); // Give other scripts time to initialize
    });
  </script>

  <!-- Safe Firebase initialization -->
  <script>
    function safeInitFirebase() {
      return new Promise(function(resolve, reject) {
        try {
          // If Firebase is not available or already initialized, resolve
          if (typeof firebase === 'undefined' || (firebase.apps && firebase.apps.length > 0)) {
            resolve(false);
            return;
          }
          
          // Get firebase config
          const fbConfig = {
            apiKey: "{{ firebase_config.apiKey }}" || "",
            authDomain: "{{ firebase_config.authDomain }}" || "",
            projectId: "{{ firebase_config.projectId }}" || "",
            storageBucket: "{{ firebase_config.storageBucket }}" || "",
            messagingSenderId: "{{ firebase_config.messagingSenderId }}" || "",
            appId: "{{ firebase_config.appId }}" || "",
            databaseURL: "{{ firebase_config.databaseURL }}" || ""
          };
          
          // Initialize Firebase
          firebase.initializeApp(fbConfig);
          console.log("Firebase initialized with safe approach");
          
          resolve(true);
        } catch (error) {
          console.error("Error in safe Firebase init:", error);
          reject(error);
        }
      });
    }
  </script>

  <!-- Safe connection manager setup -->
  <script>
    function safeSetupConnectionManager() {
      try {
        // Set up connection manager if Firebase is available
        if (typeof firebase === 'undefined' || !firebase.apps || !firebase.apps.length) {
          console.log("Firebase not initialized, skipping connection manager setup");
          return;
        }
        
        // Set up connection manager configuration
        const connectionConfig = {
          firebaseApp: firebase,
          checkInterval: 30000, // Check every 30 seconds
          skipRealtimeDatabase: true,
          onStatusChange: function(status) {
            safeUpdateSocketStatus(status.overallStatus, getStatusDescription(status));
            
            // Update last check time
            const lastCheckEl = document.getElementById('last-check-time');
            if (lastCheckEl) {
              const now = new Date();
              lastCheckEl.textContent = now.toLocaleTimeString();
            }
          }
        };
        
        // Add database URL if available
        const fbConfig = firebase.apps[0]?.options || {};
        if (fbConfig.databaseURL && fbConfig.databaseURL.includes('firebaseio.com')) {
          connectionConfig.databaseURL = fbConfig.databaseURL;
          connectionConfig.skipRealtimeDatabase = false;
        } else {
          console.log("No valid databaseURL found, will skip Realtime Database checks");
          connectionConfig.skipRealtimeDatabase = true;
        }
        
        // Create ConnectionManager with configuration
        window.connectionManager = new ConnectionManager(connectionConfig);
        
      } catch (error) {
        console.error("Error setting up connection manager - SAFE REWRITE:", error);
      }
    }
    
    // Helper to get a user-friendly status description
    function getStatusDescription(status) {
      if (!status.isOnline) return "You're offline";
      
      if (status.firebaseConnected && status.firestoreConnected) {
        return "All systems connected";
      } else if (status.firebaseConnected || status.firestoreConnected) {
        return "Partial connection";
      } else {
        return "Limited connectivity";
      }
    }
  </script>

  <!-- Safe Socket.IO setup -->
  <script>
    function safeSocketSetup() {
      try {
        console.log("Initializing Socket.IO for doctor view - SAFE REWRITE v7");
        
        // Get doctor information
        const doctorId = document.getElementById('doctor-id')?.value || 
                          "{{ session.get('user', {}).get('doctor_id', 'N/A') }}";
        
        const doctorName = document.getElementById('doctor-name')?.value || 
                            "{{ session.get('user', {}).get('name', 'Doctor') }}";
        
        console.log("Doctor info:", {userId: doctorId, userName: doctorName});
        
        // Initialize Socket.IO with error handling
        if (typeof io !== 'undefined') {
          try {
            // Connect with retry logic
            let connectionAttempts = 0;
            const maxAttempts = 3;
            
            function connectSocket() {
              try {
                if (connectionAttempts >= maxAttempts) {
                  console.error("Maximum Socket.IO connection attempts reached");
                  safeShowNotification("Connection to server failed. Some features may not work correctly.", "error");
                  return;
                }
                
                connectionAttempts++;
                console.log(`Socket.IO connection attempt ${connectionAttempts}`);
                
                // Create socket with timeout
                window.socket = io({
                  reconnectionAttempts: 5,
                  timeout: 10000,
                  reconnectionDelay: 1000,
                  transports: ['websocket', 'polling']
                });
                
                // Connection events
                window.socket.on('connect', function() {
                  console.log("Socket.IO connected successfully");
                  safeUpdateSocketStatus('Connected', 'Real-time connection established');
                  
                  // Register for doctor-specific events
                  console.log(`Registering for doctor-specific event: new-consultation-request-${doctorId}`);
                  
                  // Send doctor info to server to register for notifications
                  window.socket.emit('register-doctor', {
                    doctorId: doctorId,
                    doctorName: doctorName,
                    userRole: 'doctor'
                  });
                  
                  console.log("Doctor info sent to server:", {
                    doctorId: doctorId, 
                    doctorName: doctorName,
                    userRole: 'doctor'
                  });
                });
                
                // Connection error events
                window.socket.on('connect_error', function(error) {
                  console.error("Socket.IO connection error:", error);
                  safeUpdateSocketStatus('Error', 'Connection error');
                  
                  // Try again with polling if this was the first attempt using websocket
                  if (connectionAttempts === 1) {
                    console.log("Retrying with polling transport");
                    window.socket.disconnect();
                    window.socket = io({
                      transports: ['polling'],
                      reconnectionAttempts: 3
                    });
                  }
                });
                
                window.socket.on('connect_timeout', function() {
                  console.error("Socket.IO connection timeout");
                  safeUpdateSocketStatus('Timeout', 'Connection timed out');
                });
                
                window.socket.on('disconnect', function(reason) {
                  console.log("Socket.IO disconnected:", reason);
                  safeUpdateSocketStatus('Disconnected', reason);
                  
                  // Try to reconnect if the disconnection was unexpected
                  if (reason === 'io server disconnect') {
                    // Server disconnected us, try to reconnect manually
                    setTimeout(function() {
                      window.socket.connect();
                    }, 2000);
                  }
                });
                
                window.socket.on('error', function(error) {
                  console.error("Socket.IO error:", error);
                  safeUpdateSocketStatus('Error', 'Connection error');
                });
                
                // Register event listeners for consultation events
                window.socket.on(`new-consultation-request-${doctorId}`, function(data) {
                  console.log("New consultation request received:", data);
                  safeShowNotification("New consultation request from " + (data.patientName || "a patient"), "info");
                  
                  // Add request to UI
                  safeAddConsultationRequest(data);
                });
                
                // Event for cancelled requests
                window.socket.on(`consultation-cancelled-${doctorId}`, function(data) {
                  console.log("Consultation request cancelled:", data);
                  safeShowNotification("A consultation request was cancelled", "info");
                  
                  // Remove request from UI
                  const requestElement = document.getElementById(`request-${data.requestId}`);
                  if (requestElement) {
                    requestElement.remove();
                    
                    // Check if no requests left
                    const requestsContainer = document.getElementById('consultation-requests');
                    if (requestsContainer && requestsContainer.childElementCount === 0) {
                      // Show "no requests" message
                      const noRequestsMsg = document.getElementById('noRequestsMessage');
                      if (noRequestsMsg) {
                        noRequestsMsg.style.display = 'block';
                      }
                    }
                  }
                });
              } catch (socketError) {
                console.error("Error creating Socket.IO instance:", socketError);
                safeShowNotification("Connection error. Some features may be limited.", "error");
                
                // Try again if we haven't reached max attempts
                if (connectionAttempts < maxAttempts) {
                  setTimeout(connectSocket, 2000);
                }
              }
            }
            
            // Start connection process
            connectSocket();
            
          } catch (socketErr) {
            console.error("Socket.IO initialization error:", socketErr);
            safeShowNotification("Connection to server failed. Some features may not work correctly.", "error");
          }
        } else {
          console.error("Socket.IO library not found - real-time features will not work");
          safeShowNotification("Real-time connection not available. Please refresh the page.", "error");
        }
      } catch (error) {
        console.error("Error setting up Socket.IO - SAFE REWRITE:", error);
      }
    }
  </script>

  <!-- Safe function to add consultation request to UI -->
  <script>
    function safeAddConsultationRequest(data) {
      try {
        console.log("Adding consultation request to UI - SAFE REWRITE:", data);
        
        // If the original function exists, try to use it
        if (typeof addConsultationRequest === 'function') {
          addConsultationRequest(data);
          return;
        }
        
        // Fallback implementation
        const requestsContainer = document.getElementById('consultation-requests');
        const noRequestsMsg = document.getElementById('noRequestsMessage');
        
        if (!requestsContainer) {
          console.error("Requests container not found");
          return;
        }
        
        // Hide "no requests" message
        if (noRequestsMsg) {
          noRequestsMsg.style.display = 'none';
        }
        
        // Create request element
        const requestId = data.requestId || Date.now();
        const patientName = data.patientName || 'Anonymous Patient';
        const symptoms = data.symptoms || 'No symptoms specified';
        const urgency = data.urgency || 'Normal';
        
        const requestEl = document.createElement('div');
        requestEl.className = 'consultation-request-item';
        requestEl.id = `request-${requestId}`;
        
        // Set different class for urgent requests
        if (urgency === 'Urgent') {
          requestEl.classList.add('urgent');
        }
        
        // Create request HTML
        requestEl.innerHTML = `
          <div class="consultation-request-header">
            <div class="patient-info">
              <div class="patient-avatar">${patientName.charAt(0)}</div>
              <div>
                <h4>${patientName}</h4>
                <p class="timestamp">${new Date().toLocaleTimeString()}</p>
              </div>
            </div>
            <div class="urgency-badge ${urgency.toLowerCase()}">${urgency}</div>
          </div>
          <div class="consultation-request-body">
            <p><strong>Symptoms:</strong> ${symptoms}</p>
          </div>
          <div class="consultation-request-actions">
            <button class="btn btn-primary accept-btn" onclick="acceptConsultation('${requestId}')">
              <i class="bi bi-check-circle"></i> Accept
            </button>
            <button class="btn btn-outline-secondary reject-btn" onclick="rejectConsultation('${requestId}')">
              <i class="bi bi-x-circle"></i> Decline
            </button>
          </div>
        `;
        
        // Add to container
        requestsContainer.appendChild(requestEl);
        
        // Show consultation requests container
        const requestContainer = document.getElementById('consultation-request-container');
        if (requestContainer) {
          requestContainer.style.display = 'block';
        }
      } catch (error) {
        console.error("Error adding consultation request - SAFE REWRITE:", error);
      }
    }
  </script>
</body>
</html> 
</html> 
<!-- Fix for consultation notifications -->
<script>
  // Add a generic listener for consultation requests
  document.addEventListener('DOMContentLoaded', function() {
    if (window.socket) {
      window.socket.on('new-consultation-request', function(data) {
        console.log('Generic consultation request received:', data);
        if (typeof safeAddConsultationRequest === 'function') {
          safeAddConsultationRequest(data);
        }
        if (typeof safeShowNotification === 'function') {
          safeShowNotification('New consultation request from ' + (data.patientName || 'a patient'), 'info');
        }
      });
      window.socket.on('new-consultation-notification', function(data) {
        console.log('Generic consultation notification received:', data);
        if (typeof safeAddConsultationRequest === 'function') {
          safeAddConsultationRequest(data);
        }
        if (typeof safeShowNotification === 'function') {
          safeShowNotification('New consultation request from ' + (data.patientName || 'a patient'), 'info');
        }
      });
    }
  });
</script>
